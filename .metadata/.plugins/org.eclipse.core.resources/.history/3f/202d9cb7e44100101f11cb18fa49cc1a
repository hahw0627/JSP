<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.sql.*" %>
<%@ page import="org.json.*" %>
<%@ page import="java.io.*" %>
<%@ page import="java.nio.file.*" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JSON 데이터 DB 저장</title>
</head>
<body>
    <h1>JSON 데이터를 데이터베이스에 저장</h1>
    
    <%
    // DB 연결 정보
    String url = "jdbc:mysql://localhost:3306/tour?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true";
    String username = "root";
    String password = "hahs884312~"; // 실제 비밀번호로 변경하세요
    
    Connection conn = null;
    PreparedStatement pstmt = null;
    int insertCount = 0;
    
    try {
        // JSON 파일 읽기 (파일 경로를 실제 경로로 변경하세요)
        String jsonFilePath = application.getRealPath("/lodgment.json");
String jsonContent = new String(Files.readAllBytes(Paths.get(jsonFilePath)), "UTF-8");

        
        // JSON 파싱
        JSONObject jsonObject = new JSONObject(jsonContent);
        JSONObject jsonResponse = jsonObject.getJSONObject("response");
        JSONObject body = jsonResponse.getJSONObject("body");
        JSONObject items = body.getJSONObject("items");
        JSONArray itemArray = items.getJSONArray("item");
        
        // MySQL JDBC 드라이버 로드
        Class.forName("com.mysql.cj.jdbc.Driver");
        
        // DB 연결
        conn = DriverManager.getConnection(url, username, password);
        
        // 자동 커밋 비활성화 (배치 처리를 위해)
        conn.setAutoCommit(false);
        
        // INSERT 쿼리 준비 (기존 테이블 구조에 맞춤)
        String sql = "INSERT INTO lodgment (title, addr1, firstimage, tel) VALUES (?, ?, ?, ?)";
        pstmt = conn.prepareStatement(sql);
        
        // JSON 배열의 각 항목 처리
        for (int i = 0; i < itemArray.length(); i++) {
            JSONObject item = itemArray.getJSONObject(i);
            
            pstmt.setString(1, item.optString("title", ""));
            pstmt.setString(2, item.optString("addr1", ""));
            pstmt.setString(3, item.optString("firstimage", ""));
            pstmt.setString(4, item.optString("tel", ""));
            
            pstmt.addBatch();
            
            // 100개씩 배치 실행
            if ((i + 1) % 100 == 0) {
                int[] results = pstmt.executeBatch();
                insertCount += results.length;
                pstmt.clearBatch();
            }
        }
        
        // 남은 데이터 처리
        int[] results = pstmt.executeBatch();
        insertCount += results.length;
        
        // 커밋
        conn.commit();
        
        out.println("<div style='color: green; font-weight: bold;'>");
        out.println("성공적으로 " + insertCount + "개의 숙박 데이터를 저장했습니다!");
        out.println("</div>");
        
    } catch (Exception e) {
        if (conn != null) {
            try {
                conn.rollback();
            } catch (SQLException se) {}
        }
        out.println("<div style='color: red; font-weight: bold;'>");
        out.println("오류 발생: " + e.getMessage());
        out.println("</div>");
        e.printStackTrace();
    } finally {
        if (pstmt != null) try { pstmt.close(); } catch (SQLException e) {}
        if (conn != null) try { conn.close(); } catch (SQLException e) {}
    }
    %>
    
    <br><br>
    <a href="accommodation_list.jsp">숙박 목록 보기</a>
</body>
</html>